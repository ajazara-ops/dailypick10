name: Daily Stock Scanner

on:
  schedule:
    # 1. í•œêµ­ ì‹œê°„ ì•„ì¹¨ 08:00 (UTC ì „ë‚  23:00) -> ë¯¸êµ­ì¥ ë§ˆê°
    - cron: '0 23 * * 0-4'

    # 2. í•œêµ­ ì‹œê°„ ì €ë… 18:00 (UTC ë‹¹ì¼ 09:00) -> í•œêµ­ì¥ ë§ˆê°
    - cron: '0 9 * * 1-5'
    
    # 3. í•œêµ­ ì‹œê°„ í† ìš”ì¼ ì•„ì¹¨ 08:00 (UTC ê¸ˆìš”ì¼ 23:00) -> ì£¼ê°„ ë¦¬í¬íŠ¸
    - cron: '0 23 * * 5'

  # ğŸ‘‡ [í•µì‹¬] ìˆ˜ë™ ì‹¤í–‰ ì‹œ ë©”ë‰´ ì„ íƒ ê¸°ëŠ¥ ì¶”ê°€
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ (daily: í‰ì¼ë¶„ì„ / weekly: ì£¼ê°„ë¦¬í¬íŠ¸)'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - daily
        - weekly
      target:
        description: 'ë¶„ì„ ì‹œì¥ (daily ëª¨ë“œì¼ ë•Œë§Œ ì ìš©)'
        required: false
        default: 'ALL'
        type: choice
        options:
        - ALL
        - US
        - KR

permissions:
  contents: write

jobs:
  run-scanner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas requests lxml

      - name: Run Scan Logic
        run: |
          # 1. ì…ë ¥ê°’ ë°›ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
          MODE="${{ inputs.mode }}"
          TARGET="${{ inputs.target }}"
          
          # 2. 'auto' ì´ê±°ë‚˜ ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì¸ ê²½ìš° -> ì‹œê°„ ê¸°ë°˜ ìë™ ê²°ì •
          if [ -z "$MODE" ] || [ "$MODE" == "auto" ]; then
            HOUR=$(date +%H)
            DOW=$(date +%u)
            
            # ê¸ˆìš”ì¼ 23ì‹œ(í•œêµ­ í† ìš”ì¼ ì•„ì¹¨) -> Weekly
            if [ "$DOW" -eq 5 ] && [ "$HOUR" -eq 23 ]; then
              MODE="weekly"
            # í‰ì¼ 23ì‹œ(í•œêµ­ í‰ì¼ ì•„ì¹¨) -> Daily US
            elif [ "$HOUR" -eq 23 ]; then
              MODE="daily"
              TARGET="US"
            # í‰ì¼ 09ì‹œ(í•œêµ­ í‰ì¼ ì €ë…) -> Daily KR
            else
              MODE="daily"
              TARGET="KR"
            fi
          fi
          
          echo "ğŸš€ ì‹¤í–‰ ëª¨ë“œ: $MODE / íƒ€ê²Ÿ: $TARGET"
          
          # 3. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ "$MODE" == "weekly" ]; then
            python daily_stock_scanner.py --mode weekly
          else
            # TARGETì´ ë¹„ì–´ìˆìœ¼ë©´ ALLë¡œ ì„¤ì •
            if [ -z "$TARGET" ]; then TARGET="ALL"; fi
            python daily_stock_scanner.py --mode daily --target $TARGET
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add todays_recommendation.json
          git add history/*.json history_index.json || true
          
          git commit -m "Update Stock Data ($MODE mode)" || echo "No changes to commit"
          git push
