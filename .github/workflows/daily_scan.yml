name: Daily Stock Scanner

on:
  schedule:
    # 1. [í•œêµ­ ì£¼ì‹] ì›”~ê¸ˆ ì €ë… 18:00 KST (UTC 09:00)
    - cron: '0 9 * * 1-5'

    # 2. [ë¯¸êµ­ ì£¼ì‹] í™”~í†  ì•„ì¹¨ 08:00 KST (UTC 23:00)
    - cron: '0 23 * * 1-5'
    
    # 3. [ì£¼ê°„ ê²°ì‚°] í† ìš”ì¼ ì˜¤í›„ 17:00 KST (UTC 08:00)
    - cron: '0 8 * * 6'

  workflow_dispatch: 
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - daily
        - weekly
        - weekly_summary
      target:
        description: 'ë¶„ì„ ì‹œì¥'
        required: false
        default: 'ALL'
        type: choice
        options:
        - ALL
        - US
        - KR

permissions:
  contents: write

jobs:
  run-scanner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # [ìˆ˜ì •] 3.9 -> 3.11ë¡œ ë²„ì „ ì—…ê·¸ë ˆì´ë“œ (í•„ìˆ˜!)

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas requests lxml

      - name: Run Scan Logic
        run: |
          MODE="${{ inputs.mode }}"
          TARGET="${{ inputs.target }}"
          
          # ìë™ ëª¨ë“œ('auto')ì´ê±°ë‚˜ ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì¸ ê²½ìš° ì‹œê°„ìœ¼ë¡œ íŒë‹¨
          if [ -z "$MODE" ] || [ "$MODE" == "auto" ]; then
            HOUR=$(date +%H)
            DOW=$(date +%u)
            
            # 1. í† ìš”ì¼(6) 08ì‹œ(UTC) -> í•œêµ­ í† ìš”ì¼ 17ì‹œ -> ì£¼ê°„ ê²°ì‚° ì•Œë¦¼
            if [ "$DOW" -eq 6 ] && [ "$HOUR" -eq 08 ]; then
              MODE="weekly_summary"
              
            # 2. 23ì‹œ(UTC) -> í•œêµ­ ì•„ì¹¨ 08ì‹œ -> ë¯¸êµ­ ì£¼ì‹(US) ë¶„ì„
            elif [ "$HOUR" -eq 23 ]; then
              MODE="daily"
              TARGET="US"
              
            # 3. 09ì‹œ(UTC) -> í•œêµ­ ì €ë… 18ì‹œ -> í•œêµ­ ì£¼ì‹(KR) ë¶„ì„
            elif [ "$HOUR" -eq 09 ]; then
              MODE="daily"
              TARGET="KR"
            
            # ê·¸ ì™¸ ì‹œê°„
            else
              MODE="daily"
              TARGET="ALL"
            fi
          fi
          
          echo "ğŸš€ ì‹¤í–‰ ëª¨ë“œ: $MODE / íƒ€ê²Ÿ: $TARGET"
          
          if [ "$MODE" == "weekly" ]; then
            python daily_stock_scanner.py --mode weekly
          elif [ "$MODE" == "weekly_summary" ]; then
            python daily_stock_scanner.py --mode weekly_summary
          else
            if [ -z "$TARGET" ]; then TARGET="ALL"; fi
            python daily_stock_scanner.py --mode daily --target $TARGET
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add todays_recommendation.json
          git add daily_data/*.json weekly_reports/*.json history_index.json || true
          
          git commit -m "Update Stock Data ($MODE mode)" || echo "No changes to commit"
          git push
