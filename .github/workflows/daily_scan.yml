name: Daily Stock Scanner

on:
  schedule:
    # 1. í•œêµ­ ì‹œê°„ í‰ì¼ ì €ë… 18:00 (UTC 09:00) -> í•œêµ­ì¥ ë§ˆê° -> í•œêµ­(KR) ë¶„ì„
    # ì›”~ê¸ˆìš”ì¼
    - cron: '0 9 * * 1-5'

    # 2. í•œêµ­ ì‹œê°„ í‰ì¼+í†  ì•„ì¹¨ 08:00 (UTC ì „ë‚  23:00) -> ë¯¸êµ­ì¥ ë§ˆê° -> ë¯¸êµ­(US) ë¶„ì„
    # ì›”~ê¸ˆìš”ì¼ (UTC ê¸°ì¤€ìœ¼ë¡œëŠ” í™”~í†  ì•„ì¹¨ì— í•´ë‹¹)
    # ìˆ˜ì •: ë¯¸êµ­ì¥ì€ ì›”~ê¸ˆ ì—´ë¦¬ë¯€ë¡œ, í•œêµ­ì‹œê°„ í™”~í†  ì•„ì¹¨ì— ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨.
    - cron: '0 23 * * 1-5'
    
    # 3. í•œêµ­ ì‹œê°„ í† ìš”ì¼ ì˜¤í›„ 17:00 (UTC í† ìš”ì¼ 08:00) -> ì£¼ê°„ ìˆ˜ìµë¥  ê²°ì‚° ì•Œë¦¼
    - cron: '0 8 * * 6'

  workflow_dispatch: 
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - daily
        - weekly_summary
      target:
        description: 'ë¶„ì„ ì‹œì¥'
        required: false
        default: 'ALL'
        type: choice
        options:
        - ALL
        - US
        - KR

permissions:
  contents: write

jobs:
  run-scanner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas requests lxml

      - name: Run Scan Logic
        run: |
          MODE="${{ inputs.mode }}"
          TARGET="${{ inputs.target }}"
          
          if [ -z "$MODE" ] || [ "$MODE" == "auto" ]; then
            HOUR=$(date +%H)
            DOW=$(date +%u)
            
            # í† ìš”ì¼(6) 08ì‹œ(UTC) -> í•œêµ­ í† ìš”ì¼ 17ì‹œ -> ìˆ˜ìµë¥  ê²°ì‚° ì•Œë¦¼
            if [ "$DOW" -eq 6 ] && [ "$HOUR" -eq 08 ]; then
              MODE="weekly_summary"
              
            # í‰ì¼ 23ì‹œ(UTC) -> í•œêµ­ í‰ì¼/í†  ì•„ì¹¨ -> ë¯¸êµ­ì¥ ë¶„ì„
            elif [ "$HOUR" -eq 23 ]; then
              MODE="daily"
              TARGET="US"
              
            # í‰ì¼ 09ì‹œ(UTC) -> í•œêµ­ í‰ì¼ ì €ë… -> í•œêµ­ì¥ ë¶„ì„
            elif [ "$HOUR" -eq 09 ]; then
              MODE="daily"
              TARGET="KR"
            
            # ê·¸ ì™¸ ì‹œê°„ (ìˆ˜ë™ ì‹¤í–‰ ë“±)
            else
              MODE="daily"
              TARGET="ALL"
            fi
          fi
          
          echo "ğŸš€ ì‹¤í–‰ ëª¨ë“œ: $MODE / íƒ€ê²Ÿ: $TARGET"
          
          if [ "$MODE" == "weekly_summary" ]; then
            python daily_stock_scanner.py --mode weekly_summary
          else
            if [ -z "$TARGET" ]; then TARGET="ALL"; fi
            python daily_stock_scanner.py --mode daily --target $TARGET
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add todays_recommendation.json
          git add history/*.json history_index.json || true
          
          git commit -m "Update Stock Data ($MODE mode)" || echo "No changes to commit"
          git push
